---
title: "Final_Project"
author: "R.Riddell"
date: "10/10/2020"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(janitor)
library(lubridate)
library(ggplot2)
library(plotly)
library(htmlwidgets)
library(gganimate)


```

```{r}

```

```{r}
df <- read_csv("ks-projects-201801.csv")
dim(df)

glimpse(df)

sum(is.na(df))
naniar::gg_miss_var(df)

df <-  df %>% 
  filter(complete.cases(.))

df <- clean_names(df)

df$usd_pledged <- NULL

```

Date Day, Month, Year
```{r}
class(df$deadline)
class(df$launched)

df$launched <- date(df$launched)

df$deadline_year <- year(df$deadline)
df$deadline_month <- month(df$deadline, label = T)
df$deadline_day <- wday(df$deadline, label = T)

df$launched_year <- year(df$launched)
df$launched_month <- month(df$launched, label = T)
df$launched_day <- wday(df$launched, label = T)

df$campaign_length <- df$deadline - df$launched

df <- df %>% 
  filter(!launched == '1970-01-01')

```

Which main_categorties are most popular
```{r}
df %>% 
  group_by(main_category) %>% 
  count() %>% 
  ggplot(aes(main_category, n)) +
  geom_bar(stat = 'identity') +
  ggtitle('Total amount of campaigns') + 
  coord_flip()

df %>% 
  group_by(main_category) %>% 
  summarise(Total_pledged = sum(usd_pledged_real)) %>% 
  ggplot(aes(main_category, Total_pledged)) +
  geom_bar(stat = 'identity') +
  ggtitle('Total funding per category') + 
  coord_flip()

df %>% 
  group_by(main_category) %>% 
  summarise(Total_pledged = sum(usd_pledged_real),
            campaings = n(),
            pledged_per_campaign = Total_pledged/campaings) %>% 
  ggplot(aes(main_category, pledged_per_campaign)) +
  geom_bar(stat = 'identity') +
  ggtitle('average pledge per campaign') + 
  coord_flip()


```

subcategories of most common categories
```{r}
df %>% 
  group_by(main_category) %>% 
  summarise(unique = unique(category)) %>% 
  mutate(Num_sub.cat = length(unique)) %>% 
  select(-unique) %>% 
  summarise(num = max(Num_sub.cat)) %>% 
  ggplot(aes(main_category, num)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('Number of sub categeories per main category') 


  
df %>% 
  filter(main_category == 'Technology') %>%
  group_by(category) %>% 
  summarise(total_pledges = sum(usd_pledged_real)) %>% 
  ggplot(aes(category, total_pledges)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('Technology')


df %>% 
  filter(main_category == 'Publishing') %>% 
  group_by(category) %>% 
  summarise(total_pledges = sum(usd_pledged_real)) %>% 
  ggplot(aes(category, total_pledges)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('Publishing')

df %>% 
  filter(main_category =='Music') %>% 
  group_by(category) %>% 
  summarise(total_pledges = sum(usd_pledged_real)) %>% 
  ggplot(aes(category, total_pledges)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('Music')

df %>% 
  filter(main_category =='Film & Video') %>% 
  group_by(category) %>% 
  summarise(total_pledges = sum(usd_pledged_real)) %>% 
  ggplot(aes(category, total_pledges)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('Film & Video')

df %>% 
  filter(main_category =='Design') %>% 
  group_by(category) %>% 
  summarise(total_pledges = sum(usd_pledged_real)) %>% 
  ggplot(aes(category, total_pledges)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('Design')

```

## length of campaign
```{r}
df$campaign_length <- as.numeric(df$campaign_length)
range(df$campaign_length)

df %>%
  mutate(simple_cl = cut_interval(campaign_length, 10)) %>% 
  group_by(simple_cl) %>% 
  ggplot(aes(simple_cl, usd_pledged_real)) +
  geom_bar(stat = 'identity') +
  ggtitle('Total pledged per campaign_length')

ggplot(df,aes(campaign_length)) +
  geom_histogram() +
  ggtitle('distribution of campaign length')

ggplot(df,aes(campaign_length, usd_pledged_real)) +
  geom_bar(stat = 'identity') +
  ggtitle('Total pledged per campaign_length')

ggplot(df,aes(campaign_length, backers)) +
  geom_bar(stat = 'identity') + 
  ggtitle('number of backers per campaign_length')
```

## campaigns per country
```{r}
df %>% 
  group_by(country) %>% 
  count() %>% 
  ggplot(aes(country, n)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle('number of campaigns per country')

df %>% 
  #filter(country == 'US'|
         #country == 'GB'|
         #country == 'CA'|
         #country == 'AU') %>% 
  filter(state != 'live',
         state != 'suspended') %>% 
  group_by(country, state) %>% 
  summarise(Count = n()) %>% 
  ggplot(aes(country, Count, fill = state)) +
  geom_bar(position = 'fill', stat = 'identity') +
  ggtitle('filled barplot of country success')

df %>% 
  filter(country == 'US'|
         country == 'GB'|
         country == 'CA'|
         country == 'AU') %>% 
  filter(state != 'live',
         state != 'suspended') %>% 
  group_by(country, state) %>% 
  summarise(Count = n()) %>% 
  ggplot(aes(country, Count, fill = state)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  ggtitle('top 4 countries (by number of projects) success rate')

```

## pledge per backers per category
```{r}
df %>% 
  summarise(average_pledge = sum(usd_pledged_real)/sum(backers))

df %>% 
  group_by(state) %>% 
  summarise(average_pledge = sum(usd_pledged_real)/sum(backers)) %>% 
  ggplot(aes(state, average_pledge)) + 
  geom_bar(stat = 'identity') +
  ggtitle('average pledge based on campaign state')

df %>% 
  group_by(main_category) %>% 
  summarise(average_pledge = sum(usd_pledged_real)/sum(backers)) %>% 
  ggplot(aes(main_category, average_pledge)) + 
  geom_bar(stat = 'identity') +
  ggtitle('average pledge based on main category') +
  coord_flip()

df %>% 
  group_by(deadline_month) %>% 
  summarise(average_pledge = sum(usd_pledged_real)/sum(backers)) %>% 
  ggplot(aes(deadline_month, average_pledge)) + 
  geom_bar(stat = 'identity') +
  ggtitle('average pledge based on deadline month') +
  coord_flip()


```

## backers vs state
```{r}
df %>% 
  group_by(state) %>% 
  ggplot(aes(state,backers)) +
  geom_bar(stat = 'identity') +
  ggtitle('number of backers per state')


df %>% 
  group_by(state) %>% 
  summarise(mean_backers = mean(backers)) %>% 
  ggplot(aes(state,mean_backers)) +
  geom_bar(stat = 'identity') +
  ggtitle('Average number of backers per state')


df %>% 
  group_by(main_category) %>% 
  summarise(backer_count = sum(backers)) %>% 
  ggplot(aes(main_category,backer_count)) +
  geom_bar(stat = 'identity') +
  ggtitle('total number of backers per category') +
  coord_flip()

df %>% 
  group_by(main_category) %>% 
  summarise(backer_count = mean(backers)) %>% 
  ggplot(aes(main_category,backer_count)) +
  geom_bar(stat = 'identity') +
  ggtitle('Average backers per category') +
  coord_flip()

```
## Goal amount
```{r}
df$diff <- df$usd_pledged_real - df$usd_goal_real

df %>% 
  group_by(deadline_month) %>% 
  summarise(mean_pledge = mean(usd_pledged_real),
            mean_goal = mean(usd_goal_real)) %>%
  ggplot(aes(deadline_month,mean_pledge, group = 2)) + 
  geom_line(aes(y=mean_pledge), color = 'blue') +
  geom_line(aes(y=mean_goal), color = 'red') +
  ggtitle('mean pledged vs mean goal')
           

df %>%
  filter(state == 'failed') %>% 
  group_by(main_category) %>% 
  summarise(dif = sum(diff)) %>% 
  ggplot(aes(main_category,dif)) + 
  geom_bar(stat = "identity") +
  coord_flip() + 
  ggtitle('Total amount fallen short per campaigns | Failed campaigns')

df %>%
  filter(state == 'failed') %>% 
  group_by(main_category) %>% 
  summarise(dif = mean(diff)) %>% 
  ggplot(aes(main_category,dif)) + 
  geom_bar(stat = "identity") +
  coord_flip() + 
  ggtitle('Mean amount fallen short per campaigns | Failed campaigns')


df %>%
  filter(state == 'successful') %>% 
  group_by(main_category) %>% 
  summarise(dif = sum(diff)) %>% 
  ggplot(aes(main_category,dif)) + 
  geom_bar(stat = "identity") +
  coord_flip() + 
  ggtitle('Total amount exceeded per campaigns | Successful campaigns')

df %>%
  filter(state == 'successful') %>% 
  group_by(main_category) %>% 
  summarise(dif = mean(diff)) %>% 
  ggplot(aes(main_category,dif)) + 
  geom_bar(stat = "identity") +
  coord_flip() + 
  ggtitle('Mean amount exceeded per campaigns | Successful campaigns')


```
## Launched exploration

```{r}
df %>% 
  group_by(launched_year) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(launched_year, count, group = 1)) +
  geom_line() +
  ggtitle('projects launched per year')

df %>% 
  group_by(launched_month) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(launched_month, count, group = 1)) +
  geom_line() +
  ggtitle('projects launched per month')

df %>% 
  group_by(launched_day) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(launched_day, count, group = 1)) +
  geom_line() +
  ggtitle('projects launched per day')

df %>% 
  group_by(launched_year,state) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(launched_year, count, color = state)) +
  geom_line() +
  ggtitle('project state breakdown per year')

df %>% 
  group_by(launched_month,state) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(launched_month, count, color = state, group = state)) +
  geom_line() +
  ggtitle('project state breakdown per month')

df %>% 
  group_by(launched_day,state) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(launched_day, count, color = state, group = state)) +
  geom_line() +
  ggtitle('project state breakdown per day')

```
## transformatioon of category over time
```{r moving Line graph Kickstater popularity}
df2 <- df %>% 
  group_by(launched_year, main_category) %>% 
  summarise(count = n())

ggplot(df2, aes(launched_year, count, colour = main_category, group = main_category)) +
  geom_line() +
  gganimate::transition_reveal(launched_year)
```


```{r bubble graph the goal vs pledged size by count}
df$launched_YM <- format(as.Date(df$launched),'%Y-%m')
class(df$launched_YM)
df3 <- df %>% 
  #filter(state == 'successful') %>% 
  group_by(launched_YM,main_category) %>% 
  summarise(Count = n(),
            #cs = sum(usd_pledged_real), 
            mean_pledged = mean(usd_pledged_real),
            mean_goal = mean(usd_goal_real),.groups = 'keep') 


ggplot(df3, aes(launched_year, count, fill = main_category)) +
  geom_point()

ggplot(df3, aes(x = mean_cs, y = mean_goal)) + 
  geom_point(aes(color = main_category, size = Count), alpha = 0.5) +
  #scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07")) +
  scale_size(range = c(0.5, 12))  # Adjust the range of points size

r1 <- plot_ly(
  df3, x = ~mean_pledged, y = ~mean_goal, frame =~launched_YM,  
  color = ~main_category, type = "scatter",
  mode="markers", size=~Count,
  marker = list(symbol = 'circle', sizemode = 'diameter',
                      line = list(width = 2, color = '#FFFFFF'), opacity=0.4)) %>% 
  animation_opts(2000,redraw = F) %>% 
  animation_slider(currentvalue = list(prefix = "Year", font = list(color = 'red')))

saveWidget(r1, file=paste0( getwd(), "/r1.html"))


df4 <- df %>% 
  #filter(state == 'successful') %>% 
  group_by(launched_YM,main_category) %>% 
  summarise(Count = n(),
            pleged = sum(usd_pledged_real),
            Goal = sum(usd_goal_real),.groups = 'keep') 

r2 <- plot_ly(
  df4, x = ~pleged, y = ~Goal, frame =~launched_YM,  
  color = ~main_category, type = "scatter",
  mode="markers", size=~Count,
  marker = list(symbol = 'circle', sizemode = 'diameter',
                      line = list(width = 2, color = '#FFFFFF'), opacity=0.4)) %>% 
  animation_opts(1000, redraw = F) %>% 
  animation_slider(currentvalue = list(prefix = "Year", font = list(color = 'red')))

saveWidget(r2, file=paste0( getwd(), "/bubble1.html"))

df %>% 
  filter(main_category == 'Food' &
           launched_year == 2014 &
           launched_month == 'Jul') 

df5 <- df %>% 
  #filter(state == 'successful') %>% 
  group_by(launched_YM,main_category) %>% 
  summarise(backers = sum(backers),
            pleged = sum(usd_pledged_real),
            Number_of_concurrent_projects = n(),.groups = 'keep') 

r3 <- plot_ly(
  df5, x = ~pleged, y = ~Number_of_concurrent_projects, frame =~launched_YM,  
  color = ~main_category, type = "scatter",
  mode="markers", size=~backers,
  marker = list(symbol = 'circle', sizemode = 'diameter',
                      line = list(width = 2, color = '#FFFFFF'), opacity=0.4)) %>% 
  animation_opts(2000, redraw = F) %>% 
  animation_slider(currentvalue = list(prefix = "Year", font = list(color = 'red')))

saveWidget(r3, file=paste0( getwd(), "/bubble2.html"))

df6 <- df %>% 
  filter(launched_year > 2013) %>% 
  group_by(launched_YM,state) %>% 
  summarise(backers = sum(backers),
            mean_pleged = mean(usd_pledged_real),
            Number_of_concurrent_projects = n(),.groups = 'keep') 

r4 <- plot_ly(
  df6, x = ~mean_pleged, y = ~Number_of_concurrent_projects, frame =~launched_YM,  
  color = ~state, type = "scatter",
  mode="markers", size=~backers,
  marker = list(symbol = 'circle', sizemode = 'diameter',
                      line = list(width = 2, color = '#FFFFFF'), opacity=0.4)) %>% 
  animation_opts(500, redraw = F, mode = 'next') %>% 
  animation_slider(currentvalue = list(prefix = "Year", font = list(color = 'red')))

saveWidget(r4, file=paste0( getwd(), "/bubble4.html"))


```


```{r}
df7 <- df %>% 
  filter(state != 'live') %>% 
  group_by(state,launched_YM) %>% 
  summarise(count = n(),.groups = 'keep') %>% ungroup()

lineG <- ggplot(df7, aes(launched_YM, count, colour = state, group = state)) +
  geom_line(size = 2) +
  theme_bw() +
  transition_reveal(launched_YM, keep_last = T) + 
  view_follow() +
  ease_aes('back-in') 

animate(lineG, duration = 15, fps = 60, renderer = gifski_renderer(loop = FALSE), height = 800, width = 1600) 
anim_save <- lineG + exit_shrink()
anim_save('Line_graph.gif', animtion = anim_save)

?exit_shrink()

anim_save(lineG)
?ease_aes
accumulate_by <- function(dat, var) {
  var <- lazyeval::f_eval(var, dat)
  lvls <- plotly:::getLevels(var)
  dats <- lapply(seq_along(lvls), function(x) {
    cbind(dat[var %in% lvls[seq(1, x)], ], frame = lvls[[x]])
  })
  bind_rows(dats)
}

min_date <- min(df$launched)
min_date <- ymd_hms("2009-04-21 00:00:00")
min_Date_ms <- interval("1970-01-01 00:00:00", min_date) / dmilliseconds(1)

max_date <- max(df$launched)
max_date <- ymd_hms("2018-01-02 00:00:00")
max_Date_ms <- interval("1970-01-01 00:00:00", max_date) / dmilliseconds(1)


df$launched_YM <- parse_date(df$launched_YM, format = '%Y-%m')
class(df$launched_YM)          

fig <- df7 

fig <- fig %>%  accumulate_by(~launched_YM)

fig <- fig %>%
  plot_ly(
    x = ~launched_YM, 
    y = ~count,
    split = ~state,
    frame = ~frame,
    type = 'scatter',
    mode = 'lines+markers',
    line = list(simplyfy = F)) %>% 
  layout(xaxis = list(range = c(min_Date_ms,max_Date_ms)))
  #animation_opts(frame = 2000, redraw = F) %>% 
  #animation_slider(hide = T) %>% 
  #animation_button(x = 1, xanchor = "right", y = 0, yanchor = "bottom")

saveWidget(fig, file=paste0( getwd(), "/line.html"))

range(df7$launched_YM)
```

```{r}
library(caret)
control_obj <- trainControl(
  method = "cv",
  number = 10,
  savePredictions = "final",
  classProbs = T 
)

set.seed(345)

tree_mdl  <- train(state ~. , data = df_c ,
                   method = 'rpart',
                   tuneGrid = expand.grid(cp = seq(0.01,0.1,0.01)),
                   trControl = control_obj,
                   metric = "ROC")

tree_mdl
plot(tree_mdl)
rattle::fancyRpartPlot(tree_mdl$finalModel, sub = "", palettes = 'RdBu')
plot(varImp(tree_mdl), top =20)

glimpse(df_c)

df_c <- df

df_c <- df_c %>% 
  slice(1:50000)

df_c <- df_c  %>% 
  select(-c(diff, name, id, pledged,usd_pledged_real))


df_c <- df_c  %>% 
  filter(state == 'successful'|
           state == 'failed')

df_c <- df_c %>% 
  mutate_at(vars(category,main_category,currency,country,state), as.factor)

df_c$state <- factor(df_c$state)

levels(droplevels(df_c$state))

unique(df_c$state)
```

```{r Shiny category based success or failure}

sdf <- df %>% 
  group_by(main_category,state) %>% 
  filter(state != 'live', state != 'suspended') %>% 
  count()
  

library(shiny)

ui <- fluidPage(
  #numericInput(inputId = "n",
               #"sample size", value = 25),
      selectInput("mySelectInput", 
                  'Select from the dropdown:',
                  choices = unique(sdf$main_category)),
  plotOutput(outputId = "scatter"),
  textOutput("niceSelectOutput"))

server <- function(input,output){
  
  xvalues <- reactive({sdf %>% filter(main_category == input$mySelectInput) %>% ungroup() %>%  select(state)})
  yvalues <- reactive({sdf %>% filter(main_category == input$mySelectInput) %>% ungroup() %>%  select(n)})
  
  output$scatter <- renderPlot({
    ggplot(data = NULL,aes(unlist(xvalues()),unlist(yvalues()))) + geom_bar(stat = 'identity') +
      xlab(input$mySelectInput) +
      ggtitle("Distribution of Iris data") +
      theme_bw()})

}

shinyApp(ui = ui, server = server)

x <- sdf %>% filter(main_category == 'Art') %>% ungroup() %>%  select(state)
y <- sdf %>% filter(main_category == 'Art') %>% ungroup() %>%  select(n)

ggplot(sdf,aes(unlist(x),unlist(y))) + geom_bar(stat = 'identity')



```

```{r}
sum(df$usd_pledged_real)
sum(df$usd_goal_real)

df %>% 
  group_by(state) %>% 
  count()
```

